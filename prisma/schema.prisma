// CareSphere API — Prisma Schema
// Migrated from caresphere-api (Python/FastAPI + SQLAlchemy/MySQL → PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum UserRole {
  KINGDOM_SUPER_ADMIN // Platform-wide global admin — EKD Digital internal only
  SUPER_ADMIN // Organisation owner / super admin
  ADMIN // Organisation admin
  MINISTRY_LEADER // Ministry / department leader
  VOLUNTEER // Volunteer / team helper
  MEMBER // Standard member
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ORGANIZATION covers any collective entity: church, mosque, synagogue,
// ministry, group, family unit, etc. — used when a member record
// represents an institution rather than an individual person.
enum Gender {
  MALE
  FEMALE
  ORGANIZATION
}

// CHURCH covers all faith-based entities (church, mosque, synagogue, temple, ministry).
// Use NONPROFIT for non-faith non-profits. Use OTHER for anything else.
enum OrganizationType {
  CHURCH
  NONPROFIT
  OTHER
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  PENDING
  ARCHIVED
}

enum MessageType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum MessageStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum RecipientStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
}

enum TemplateType {
  EMAIL
  SMS
  PUSH
}

enum SettingScope {
  GLOBAL
  ORGANIZATION
  USER
}

enum FieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  TEXTAREA
  URL
  FILE
}

enum EntityType {
  MEMBER
  MESSAGE
  EVENT
  DONATION
  VOLUNTEER
}

// ─── Models ──────────────────────────────────────────────────────────────────

model User {
  id                    String     @id @default(uuid())
  email                 String     @unique
  passwordHash          String     @map("password_hash")
  firstName             String     @map("first_name")
  lastName              String?    @map("last_name")
  displayName           String?    @map("display_name")
  avatarUrl             String?    @map("avatar_url")
  phone                 String?
  role                  UserRole   @default(MEMBER)
  status                UserStatus @default(ACTIVE)
  emailVerified         Boolean    @default(false) @map("email_verified")
  lastLoginAt           DateTime?  @map("last_login_at")
  resetTokenHash        String?    @map("reset_token_hash")
  resetTokenExpires     DateTime?  @map("reset_token_expires")
  verificationTokenHash String?    @map("verification_token_hash")
  organizationId        String?    @map("organization_id")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  organization            Organization?      @relation(fields: [organizationId], references: [id])
  organizationMemberships OrganizationUser[] @relation("UserMemberships")
  invitedUsers            OrganizationUser[] @relation("InvitedUsers")
  createdMembers          Member[]           @relation("MemberCreator")
  createdNotes            MemberNote[]       @relation("NoteCreator")
  createdActivities       MemberActivity[]   @relation("ActivityCreator")
  createdMessages         Message[]          @relation("MessageCreator")
  createdTemplates        Template[]         @relation("TemplateCreator")
  createdAutomations      AutomationRule[]   @relation("AutomationCreator")
  // Bible feature relations
  bibleVotdSet            BibleVerseOfDay[]  @relation("VotdSetter")
  bibleBookmarks          BibleBookmark[]    @relation("UserBookmarks")
  bibleNotes              BibleNote[]        @relation("UserBibleNotes")
  bibleHighlights         BibleHighlight[]   @relation("UserHighlights")

  @@map("users")
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  codeHash  String   @map("code_hash")
  expiresAt DateTime @map("expires_at")
  verified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("email_verifications")
}

model Organization {
  id               String           @id @default(uuid())
  name             String
  slug             String           @unique
  organizationCode String           @unique @map("organization_code")
  organizationType OrganizationType @default(CHURCH) @map("organization_type")
  domain           String?
  description      String?
  logoUrl          String?          @map("logo_url")
  website          String?
  phone            String?
  address          String?
  city             String?
  state            String?
  country          String?
  timezone         String?          @default("UTC")
  // Bible features are auto-enabled for faith-based org types
  bibleEnabled     Boolean          @default(false) @map("bible_enabled")
  settings         Json             @default("{}")
  isActive         Boolean          @default(true) @map("is_active")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  users           User[]
  members         OrganizationUser[]
  roles           Role[]
  fieldConfigs    FieldConfiguration[]
  senderSettings  SenderSetting[]
  bibleVerseOfDay BibleVerseOfDay[]
  bibleHighlights BibleHighlight[]

  @@map("organizations")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  category    String
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  roles RolePermission[]

  @@map("permissions")
}

model Role {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  displayName    String   @map("display_name")
  description    String?
  isSystem       Boolean  @default(false) @map("is_system")
  isActive       Boolean  @default(true) @map("is_active")
  color          String   @default("#6B7280")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions       RolePermission[]
  organizationUsers OrganizationUser[]

  @@map("roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model OrganizationUser {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")
  roleId         String?   @map("role_id")
  isOwner        Boolean   @default(false) @map("is_owner")
  isActive       Boolean   @default(true) @map("is_active")
  invitedBy      String?   @map("invited_by")
  joinedAt       DateTime? @map("joined_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user         User         @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade)
  inviter      User?        @relation("InvitedUsers", fields: [invitedBy], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role?        @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@map("organization_users")
}

model Member {
  id             String       @id @default(uuid())
  organizationId String?      @map("organization_id")
  userId         String?      @map("user_id")
  firstName      String       @map("first_name")
  lastName       String?      @map("last_name")
  email          String?
  phone          String?
  dateOfBirth    DateTime?    @map("date_of_birth")
  gender         Gender?
  address        String?
  city           String?
  state          String?
  zipCode        String?      @map("zip_code")
  country        String?
  memberStatus   MemberStatus @default(ACTIVE) @map("member_status")
  membershipType String?      @map("membership_type")
  joinDate       DateTime?    @map("join_date")
  photoUrl       String?      @map("photo_url")
  notes          String?
  tags           Json         @default("[]")
  customFields   Json         @default("{}") @map("custom_fields")
  workSchool     String?      @map("work_school")
  whatsappNumber String?      @map("whatsapp_number")
  wechatId       String?      @map("wechat_id")
  hearAboutUs    String?      @map("hear_about_us")
  involvement    String?
  comments       String?
  consentGiven   Boolean      @default(false) @map("consent_given")
  createdBy      String?      @map("created_by")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  creator     User?            @relation("MemberCreator", fields: [createdBy], references: [id])
  memberNotes MemberNote[]
  activities  MemberActivity[]

  @@index([organizationId])
  @@index([email])
  @@map("members")
}

model MemberNote {
  id        String   @id @default(uuid())
  memberId  String   @map("member_id")
  note      String
  noteType  String?  @map("note_type")
  isPrivate Boolean  @default(false) @map("is_private")
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  member  Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  creator User?  @relation("NoteCreator", fields: [createdBy], references: [id])

  @@index([memberId])
  @@map("member_notes")
}

model MemberActivity {
  id               String   @id @default(uuid())
  memberId         String   @map("member_id")
  activityType     String   @map("activity_type")
  description      String?
  activityMetadata Json     @default("{}") @map("metadata")
  createdBy        String?  @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  member  Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  creator User?  @relation("ActivityCreator", fields: [createdBy], references: [id])

  @@index([memberId])
  @@map("member_activities")
}

model Template {
  id           String       @id @default(uuid())
  name         String
  description  String?
  templateType TemplateType @default(EMAIL) @map("template_type")
  category     String?
  subject      String?
  content      String       @db.Text
  variables    String?
  thumbnailUrl String?      @map("thumbnail_url")
  isActive     Boolean      @default(true) @map("is_active")
  usageCount   Int          @default(0) @map("usage_count")
  createdBy    String       @map("created_by")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  creator  User      @relation("TemplateCreator", fields: [createdBy], references: [id])
  messages Message[]

  @@map("templates")
}

model MessageSenderProfile {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  name           String
  email          String?
  phone          String?
  isDefault      Boolean  @default(false) @map("is_default")
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  messages Message[]

  @@map("message_sender_profiles")
}

model Message {
  id              String        @id @default(uuid())
  title           String
  content         String        @db.Text
  messageType     MessageType   @default(EMAIL) @map("message_type")
  status          MessageStatus @default(DRAFT)
  scheduledFor    DateTime?     @map("scheduled_for")
  sentAt          DateTime?     @map("sent_at")
  senderName      String?       @map("sender_name")
  senderEmail     String?       @map("sender_email")
  senderPhone     String?       @map("sender_phone")
  templateId      String?       @map("template_id")
  senderProfileId String?       @map("sender_profile_id")
  createdBy       String        @map("created_by")
  recipientCount  Int           @default(0) @map("recipient_count")
  openedCount     Int           @default(0) @map("opened_count")
  clickedCount    Int           @default(0) @map("clicked_count")
  failedCount     Int           @default(0) @map("failed_count")
  messageMetadata Json          @default("{}") @map("metadata")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  creator       User                  @relation("MessageCreator", fields: [createdBy], references: [id])
  template      Template?             @relation(fields: [templateId], references: [id])
  senderProfile MessageSenderProfile? @relation(fields: [senderProfileId], references: [id])
  recipients    MessageRecipient[]

  @@map("messages")
}

model MessageRecipient {
  id             String          @id @default(uuid())
  messageId      String          @map("message_id")
  memberId       String?         @map("member_id")
  recipientEmail String?         @map("recipient_email")
  recipientPhone String?         @map("recipient_phone")
  status         RecipientStatus @default(PENDING)
  sentAt         DateTime?       @map("sent_at")
  openedAt       DateTime?       @map("opened_at")
  clickedAt      DateTime?       @map("clicked_at")
  errorMessage   String?         @map("error_message")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_recipients")
}

model AutomationRule {
  id            String    @id @default(uuid())
  name          String
  description   String?
  triggerType   String    @map("trigger_type")
  triggerConfig Json      @default("{}") @map("trigger_config")
  actionType    String    @map("action_type")
  actionConfig  Json      @default("{}") @map("action_config")
  conditions    Json      @default("{}")
  isActive      Boolean   @default(true) @map("is_active")
  lastRunAt     DateTime? @map("last_run_at")
  runCount      Int       @default(0) @map("run_count")
  successCount  Int       @default(0) @map("success_count")
  failureCount  Int       @default(0) @map("failure_count")
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  creator User            @relation("AutomationCreator", fields: [createdBy], references: [id])
  logs    AutomationLog[]

  @@map("automation_rules")
}

model AutomationLog {
  id              String    @id @default(uuid())
  ruleId          String    @map("rule_id")
  status          String
  triggerData     Json      @default("{}") @map("trigger_data")
  actionResult    Json      @default("{}") @map("action_result")
  errorMessage    String?   @map("error_message")
  executionTimeMs Int?      @map("execution_time_ms")
  executedAt      DateTime? @map("executed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  rule AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@map("automation_logs")
}

model SenderSetting {
  id             String       @id @default(uuid())
  scope          SettingScope
  referenceId    String?      @map("reference_id")
  senderName     String?      @map("sender_name")
  senderEmail    String?      @map("sender_email")
  senderPhone    String?      @map("sender_phone")
  organizationId String?      @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization? @relation(fields: [organizationId], references: [id])

  @@unique([scope, referenceId], name: "uq_sender_settings_scope_ref")
  @@map("sender_settings")
}

model FieldConfiguration {
  id              String     @id @default(uuid())
  organizationId  String     @map("organization_id")
  entityType      EntityType @map("entity_type")
  fieldKey        String     @map("field_key")
  fieldLabel      String     @map("field_label")
  fieldType       FieldType  @default(TEXT) @map("field_type")
  description     String?
  placeholder     String?
  options         Json       @default("[]")
  validationRules Json       @default("{}") @map("validation_rules")
  isRequired      Boolean    @default(false) @map("is_required")
  isVisible       Boolean    @default(true) @map("is_visible")
  isSearchable    Boolean    @default(false) @map("is_searchable")
  displayOrder    Int        @default(0) @map("display_order")
  defaultValue    String?    @map("default_value")
  groupName       String?    @map("group_name")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fieldValues  FieldValue[]

  @@index([organizationId])
  @@index([entityType])
  @@map("field_configurations")
}

model FieldValue {
  id                   String     @id @default(uuid())
  fieldConfigurationId String     @map("field_configuration_id")
  entityType           EntityType @map("entity_type")
  entityId             String     @map("entity_id")
  value                String?    @db.Text
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  fieldConfiguration FieldConfiguration @relation(fields: [fieldConfigurationId], references: [id], onDelete: Cascade)

  @@unique([fieldConfigurationId, entityType, entityId], name: "uq_field_value_cfg_entity")
  @@index([fieldConfigurationId])
  @@index([entityId])
  @@map("field_values")
}

// ─── Bible Feature Models (available to faith-based organizations) ────────────

// Persisted cache of API responses (YouVersion / API.Bible) to avoid
// hitting rate limits and to support offline/degraded-mode operation.
model BibleCache {
  id           String   @id @default(uuid())
  cacheKey     String   @unique @map("cache_key") // e.g. "yv:verse:JHN.3.16.KJV"
  provider     String // "youversion" | "apibible"
  resourceType String   @map("resource_type") // "verse" | "passage" | "chapter" | "search" | "translations" | "books"
  payload      Json // raw normalized response
  expiresAt    DateTime @map("expires_at")
  hitCount     Int      @default(0) @map("hit_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("bible_cache")
}

// Org-level Verse of the Day configuration & history
model BibleVerseOfDay {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  reference      String // e.g. "John 3:16"
  translationId  String   @map("translation_id") // e.g. "de4e12af7fb563a2796e53de5f43c8c"
  verseText      String   @map("verse_text") @db.Text
  provider       String   @default("youversion")
  scheduledDate  DateTime @map("scheduled_date") @db.Date
  isAutomatic    Boolean  @default(true) @map("is_automatic") // true = fetched from provider
  setBy          String?  @map("set_by") // userId if manually set
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  setter       User?        @relation("VotdSetter", fields: [setBy], references: [id])

  @@unique([organizationId, scheduledDate], name: "uq_votd_org_date")
  @@index([organizationId])
  @@index([scheduledDate])
  @@map("bible_verse_of_day")
}

// User-saved verse bookmarks
model BibleBookmark {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  reference     String // e.g. "John 3:16"
  translationId String   @map("translation_id")
  verseText     String   @map("verse_text") @db.Text
  provider      String   @default("youversion")
  collection    String? // optional grouping label
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation("UserBookmarks", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, reference, translationId], name: "uq_bookmark_user_ref_trans")
  @@index([userId])
  @@map("bible_bookmarks")
}

// User notes attached to specific verses
model BibleNote {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  reference     String
  translationId String   @map("translation_id")
  noteText      String   @map("note_text") @db.Text
  isPrivate     Boolean  @default(true) @map("is_private")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation("UserBibleNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reference])
  @@map("bible_notes")
}

// User highlights — colour-coded verse highlighting
model BibleHighlight {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String?  @map("organization_id")
  reference      String
  translationId  String   @map("translation_id")
  color          String   @default("#FFD700") // hex highlight colour
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User          @relation("UserHighlights", fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([userId, reference, translationId], name: "uq_highlight_user_ref_trans")
  @@index([userId])
  @@map("bible_highlights")
}
